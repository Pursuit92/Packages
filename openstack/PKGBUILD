# Maintainer: Josh Chase <jcjoshuachase@gmail.com>

pkgname=('nova' 'glance' 'keystone' 'swift')
pkgver=essex
_novaver=2012.1.2
_glancever=2012.1.2
_keystonever=2012.1.2
_horizonver=2012.1.1
_swiftver=1.4.8
pkgrel=1
pkgdesc="OpenStack Cloud Platform"
arch=('any')
license=('apache')
url="https://launchpad.net/openstack"
depends=('python2'
         #'rabbitmq'
         #bridge-utils'
         #libxslt'
         #ebtables'
         #libguestfs'
         #dnsmasq')
)
groups=openstack-essex
makedepends=('python2-virtualenv')
source=("https://launchpad.net/nova/$pkgver/$_novaver/+download/nova-$_novaver.tar.gz"
        "https://launchpad.net/glance/$pkgver/$_glancever/+download/glance-$_glancever.tar.gz"
        "https://launchpad.net/keystone/$pkgver/$_keystonever/+download/keystone-$_keystonever.tar.gz"
	"https://launchpad.net/swift/$pkgver/$_swiftver/+download/swift-$_swiftver.tar.gz")
md5sums=('e829334fc8ba90160c59801ff372d003'
         '544496fde64a341a4f39e15f4b258093'
         '026dfa10e37108b75b92d39cbc449bd0'
	 '785ae9ba4e1f6fc256cd6a697bb2861f')

builddir=$srcdir/../build
venv=$builddir/opt/openstack-essex

build() {

  pushd $srcdir

  find . -type f -exec sed -i -e 's|^#!/usr/bin/python$|#!/usr/bin/python2|' \
    -e 's|^#!/usr/bin/env python$|#!/usr/bin/env python2|' {} +


  # Build the virtualenv and install dependencies
  mkdir -p $venv/{nova,keystone,glance} /tmp/piptemp

  for i in *
  do
    if [ -d $i ]; then
  
      svc=$(echo $i | sed 's/-.*//')
      virtualenv2 $venv/$svc
    
      # Just get the requirements that don't have a specific version
      cat $i/tools/pip-requires | sed -e '/^#/ d' -e '/^https\?:\/\// d' -e '/-e/ d' -e '/[<>=].*/ p' | sed -e 's/[<>=].*//' -e 's/\(.*\)/\L\1/'| sort | uniq -u > requires
    
      # Get only the requirements with a specific version
      cat $i/tools/pip-requires | sed -e '/^$/ d' -e '/-e/ d' -e '/^https\?:\/\// d' | grep == | sed 's/\(.*\)/\L\1/' | sort | uniq >> requires
  
      $venv/$svc/bin/pip install --download-cache /tmp/piptemp -r requires 
    
      pushd $i
      $venv/$svc/bin/python setup.py build
      popd
    
  
    fi
  done

  popd

}

_package() {
  svc=$1
  pushd $svc-*
  $venv/$svc/bin/python setup.py install --optimize=1
  if [ ! -d etc/$svc ] 
  then
    cp -Tr etc $builddir/etc/$svc
  else
    cp -r etc/$svc $builddir/etc/
  fi
  popd

  virtualenv2 --relocatable $venv/$svc
  
  mkdir -p $pkgdir/{etc,opt/openstack-essex/$svc}
  cp -Tr $venv/$svc $pkgdir/opt/openstack-essex/$svc
  cp -Tr $builddir/etc/$svc $pkgdir/etc/$svc
}

package_nova() {
  backup=( 'etc/nova/nova.conf'
           'etc/nova/api-paste.ini')
  _package nova
}

package_glance() {
  backup=( 'etc/glance/glance-api.conf'
           'etc/glance/glance-registry.conf'
           'etc/glance/glance-api-paste.ini'
           'etc/glance/glance-registry-paste.ini' )
  _package glance
}

package_keystone() {
  backup=( 'etc/keystone/keystone.conf' )
  depends=( 'libxslt' )
  _package keystone
}

package_swift() {
#  backup=( 'etc/nova/nova.conf'
#           'etc/nova/api-paste.ini')
  _package swift
}
