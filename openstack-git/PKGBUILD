# Maintainer: Josh Chase <jcjoshuachase@gmail.com>

pkgname=('nova' 'glance' 'keystone' 'swift')
pkgver=essex
_novaver=2012.1.2
_glancever=2012.1.2
_keystonever=2012.1.2
_horizonver=2012.1.1
_swiftver=1.4.8
pkgrel=1
pkgdesc="OpenStack Cloud Platform"
arch=('any')
license=('apache')
url="https://launchpad.net/openstack"
depends=('python2')
source=("glance-api.service"
        "glance-registry.service"
        "keystone.service"
        "nova-api.service"
        "nova-cert.service"
        "nova-compute.service"
        "nova-console.service"
        "nova-consoleauth.service"
        "nova-network.service"
        "nova-scheduler.service"
        "nova-volume.service")
md5sums=('593ac14275831ea610eafe366140b454'
         'e87a5b58ef916128ba9e8cde65d46f1f'
         '8902d8552ea9e4f8a3f3a6885e77b478'
         'adfe75fec801ba8dd808c16a505070b3'
         'c697788e304f1af9b247edd51f29fa6d'
         '1c3c6bcc1c7f83c27a797a216236b117'
         'f7d01e8e2c828cbd44e70ad6c4929e03'
         'f57b9da4cc8d8ab875253015de150da0'
         '344d924112d788bad5eec15953f0d065'
         'cedee4dca70c668b860440f216333e93'
         '5dc7a1e82fb80dffd86ba3c6d59ed7c7')
groups=openstack-essex
makedepends=('python2-virtualenv')

builddir=$srcdir/../build
venv=$builddir/opt/openstack-essex

build() {

  pushd $srcdir
  for i in ${pkgname[*]}
  do
    if [ -d $i ]; then
      echo "Directory found, not cloning."
    else
      git clone https://github.com/openstack/$i $i --depth=1 --branch stable/essex
    fi
  done

  find . -type f -exec sed -i -e 's|^#!/usr/bin/python$|#!/usr/bin/python2|' \
    -e 's|^#!/usr/bin/env python$|#!/usr/bin/env python2|' {} +


  # Build the virtualenv and install dependencies
  mkdir -p /tmp/piptemp $builddir/etc

  for i in *
  do
    if [ -d $i ]; then
  
      svc=$i
      mkdir -p $venv/$svc

      virtualenv2 $venv/$svc
    
      [ -e $i/tools/pip-requires ] && $venv/$svc/bin/pip install --download-cache /tmp/piptemp -r $i/tools/pip-requires
      [[ $svc == nova ]] && $venv/$svc/bin/pip install keystone
    
      pushd $i
      pwd
      $venv/$svc/bin/python setup.py build
      popd
    
  
    fi
  done

  popd

}

_package() {
  svc=$1
  pushd $srcdir/$svc
  $venv/$svc/bin/python setup.py install --optimize=1
  if [ ! -d etc/$svc ] 
  then
    cp -Tr etc $builddir/etc/$svc
  else
    cp -r etc/$svc $builddir/etc/
  fi
  popd

  virtualenv2 --relocatable $venv/$svc
  
  mkdir -p $pkgdir/{etc,usr/lib/systemd/system,opt/openstack-essex/$svc}
  for i in $srcdir/$svc*service; do
    install -Dm755 $i $pkgdir/usr/lib/systemd/system/
  done
  cp -Tr $venv/$svc $pkgdir/opt/openstack-essex/$svc
  cp -Tr $builddir/etc/$svc $pkgdir/etc/$svc
}

package_nova() {
depends=('bridge-utils'
         'libxslt'
         'ebtables'
         'libguestfs'
         'dnsmasq')
  backup=( 'etc/nova/nova.conf'
           'etc/nova/api-paste.ini')
  _package nova
}

package_glance() {
  backup=( 'etc/glance/glance-api.conf'
           'etc/glance/glance-registry.conf'
           'etc/glance/glance-api-paste.ini'
           'etc/glance/glance-registry-paste.ini' )
  _package glance
}

package_keystone() {
  backup=( 'etc/keystone/keystone.conf' )
  depends=( 'libxslt' )
  _package keystone
}

package_swift() {
#  backup=( 'etc/nova/nova.conf'
#           'etc/nova/api-paste.ini')
  _package swift
}
